---
import Analytics from "../components/Analytics.astro";
/** 统一文章布局：OG/Twitter/JSON-LD 自动注入，缺省自动生成 og:image */
const { frontmatter } = Astro.props;
const title = frontmatter?.title ?? 'Untitled';
const description = frontmatter?.description ?? 'Notes on football analytics & tools.';
const date = frontmatter?.date ? new Date(frontmatter.date) : undefined;
const tags = Array.isArray(frontmatter?.tags) ? frontmatter.tags : [];
const site = Astro.site ?? new URL('https://my-footy-site.pages.dev/');
const canonical = new URL(Astro.url.pathname, site).toString();

/** 自动 OG 图：
 * 优先使用 frontmatter.ogImage（相对路径或绝对 URL）
 * 否则使用 Vercel og-image 动态生成 PNG（跨平台抓取友好）
 */
const ogImage = frontmatter?.ogImage
  ? (frontmatter.ogImage.startsWith('http')
      ? frontmatter.ogImage
      : new URL(frontmatter.ogImage.replace(/^\/+/, ''), site).toString())
  : `https://og-image.vercel.app/${encodeURIComponent(title)}.png?` +
    `desc=${encodeURIComponent(description)}&theme=light&md=1&fontSize=70px`;

const iso = date ? date.toISOString() : undefined;

const style = `
  :root{--c:#111;--m:#666;--bd:#eee;--bg:#fff}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--c); background:var(--bg);
       max-width:860px; margin:24px auto; padding:0 16px}
  header{margin:6px 0 18px}
  nav a{color:#0a58ca; text-decoration:none; margin-right:10px}
  nav a:hover{text-decoration:underline}
  article{border:1px solid var(--bd); border-radius:14px; padding:18px}
  h1{font-size:32px; line-height:1.2; margin:0 0 6px}
  .meta{color:var(--m); font-size:14px; margin-bottom:8px}
  .tags{margin-left:6px}
  .tags span{display:inline-block; border:1px solid var(--bd); border-radius:999px; padding:2px 8px; margin-right:6px; font-size:12px; color:#444}
  article :where(h2,h3){margin-top:20px}
  article img{max-width:100%; border-radius:8px}
  footer{color:var(--m); font-size:13px; margin:14px 2px}
`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title} · Footy Analytics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <!-- Open Graph -->
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Footy Analytics" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- JSON-LD: Article -->
    <script type="application/ld+json">
{JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  datePublished: iso,
  dateModified: iso,
  mainEntityOfPage: canonical,
  author: [{ '@type': 'Person', name: 'Footy Analytics' }],
  publisher: { '@type': 'Organization', name: 'Footy Analytics' },
}, null, 0)}
    </script>

    <!-- RSS 自动发现（防止首页未引入） -->
    <link rel="alternate" type="application/rss+xml" title="Footy Analytics RSS" href="/rss.xml" />
    <style is:global set:html={style}></style>
    <Analytics />
</head>
  <body>
    <header>
      <nav>
        <a href="/">Home</a>·
        <a href="/articles">Articles</a>·
        <a href="/tools/poisson">Poisson</a>·
        <a href="/tools/implied-odds">Implied odds</a>·
        <a href="/tools/kelly">Kelly</a>·
        <a href="/rss.xml">RSS</a>
      </nav>
    </header>

    <article>
      <h1>{title}</h1>
      <div class="meta">
        {iso && <time datetime={iso}>{new Date(iso).toLocaleDateString('en-GB')}</time>}
        {tags.length > 0 && (
          <span class="tags">
            {tags.map((t) => <span>{t}</span>)}
          </span>
        )}
      </div>
      <slot />
    </article>

    <footer>
      <p>Tip: try the <a href="/tools/poisson">Poisson calculator</a>, <a href="/tools/implied-odds">overround remover</a>, and <a href="/tools/kelly">Kelly stake</a>.</p>
    </footer>
  </body>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-184RY50MWX"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-184RY50MWX');</script>
</html>
