---
import AppLayout from '../../../layouts/AppLayout.astro';
const title = 'Kelly · Footy Analytics';
const jsonLd = {"@context":"https://schema.org","@type":"SoftwareApplication","name":"Kelly Calculator","applicationCategory":"SportsApplication","operatingSystem":"Web","url":Astro.request.url};
---
<AppLayout title={title} description="给定概率与赔率，计算 Kelly 与下注额（含上限）" jsonLd={jsonLd} active="kelly">
  <style>
    :root{--w:720px}
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
    input{width:100%;padding:.4rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr 40px;gap:.5rem;align-items:center;margin:.4rem 0}
    button{padding:.5rem .8rem;border:1px solid #ddd;border-radius:.6rem;background:#fafafa;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7rem}
  </style>

  <h1>Kelly</h1>
  <div class="card grid">
    <label>Bankroll<input id="bank" value="1000" inputmode="decimal"/></label>
    <label>单注上限（比例）<input id="cap" value="0.10" inputmode="decimal"/></label>
    <div style="display:flex;gap:.6rem;align-self:end"><button id="add">+ 添加项</button><button id="calc">Calculate</button></div>
  </div>

  <div class="card" style="margin-top:1rem">
    <div id="rows"></div>
    <table style="margin-top:.6rem">
      <thead><tr><th>#</th><th>p(%)</th><th>odds</th><th>Kelly frac</th><th>stake(¥)</th></tr></thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <script type="module">
  const $ = (id) => document.getElementById(id);

  function parseOdds(input) {
    const s = String(input || '').trim().replace(',', '.');
    if (!s) throw new Error('empty odds');
    if (/^\s*\d+\s*\/\s*\d+\s*$/.test(s)) {
      const [a, b] = s.split('/').map(Number);
      if (!b) throw new Error('invalid fractional');
      return 1 + a / b;
    }
    if (/^[+-]?\d+$/.test(s)) {
      const n = Number(s);
      if (n >= 100) return 1 + n / 100;
      if (n <= -100) return 1 + 100 / Math.abs(n);
    }
    const d = Number(s);
    if (!Number.isFinite(d) || d <= 1) throw new Error('invalid decimal odds');
    return d;
  }

  const fmtOdds = (x, d = 2) => Number(x).toFixed(d);

  function kellyFrac(p, decOdds) {
    const b = decOdds - 1;
    const f = (p * decOdds - 1) / b;
    return Math.max(0, f);
  }

  function stake(bankroll, frac, capRatio = 0.1) {
    return Math.max(0, Math.min(bankroll * frac, bankroll * capRatio));
  }

  const rows = $('rows');
  const tb = $('tb');

  function addRow(p = '40', o = '2.10') {
    const d = document.createElement('div');
    d.className = 'row';
    d.innerHTML = `<input placeholder="概率% (如 40)" value="${p}"/><input placeholder="赔率 (可+120/13/10/2.1)" value="${o}"/><div></div><button aria-label="删除">×</button>`;
    rows.appendChild(d);
    d.querySelector('button').addEventListener('click', () => d.remove());
  }

  ['40|2.10', '30|3.40', '28|3.60'].forEach((s) => {
    const [p, o] = s.split('|');
    addRow(p, o);
  });

  $('add').addEventListener('click', () => addRow('33', '3.00'));

  function calc() {
    try {
      const bank = Number(String($('bank').value).replace(',', '.')) || 0;
      const cap = Number(String($('cap').value).replace(',', '.')) || 0.1;

      const items = [...rows.querySelectorAll('.row')].map((r, i) => {
        const ins = r.querySelectorAll('input');
        const p = Math.max(0, Math.min(1, Number(ins[0].value) / 100));
        const odds = parseOdds(ins[1].value);
        const frac = kellyFrac(p, odds);
        const st = stake(bank, frac, cap);
        return { i: i + 1, p, odds, frac, st };
      });

      tb.innerHTML = items
        .map(
          (x) =>
            `<tr><td>${x.i}</td><td>${(x.p * 100).toFixed(2)}%</td><td>${fmtOdds(x.odds)}</td><td>${(x.frac * 100).toFixed(2)}%</td><td>${x.st.toFixed(2)}</td></tr>`
        )
        .join('');
    } catch (e) {
      tb.innerHTML = `<tr><td colspan="5">Error: ${String(e)}</td></tr>`;
    }
  }

  $('calc').addEventListener('click', calc);
  calc();
</script>
</AppLayout>
