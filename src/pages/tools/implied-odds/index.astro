---
import AppLayout from '../../../layouts/AppLayout.astro';
const title = 'Implied Odds · Footy Analytics';
const jsonLd = {"@context":"https://schema.org","@type":"SoftwareApplication","name":"Implied Odds","applicationCategory":"SportsApplication","operatingSystem":"Web","url":Astro.request.url};
---
<AppLayout title={title} description="从市场赔率计算隐含概率、归一化与公平赔率" jsonLd={jsonLd} active="implied">
  <style>
    :root{--w:720px}
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
    button{padding:.5rem .8rem;border:1px solid #ddd;border-radius:.6rem;background:#fafafa;cursor:pointer}
    input{width:100%;padding:.45rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    .row{display:grid;grid-template-columns:1fr 120px 40px;gap:.5rem;align-items:center;margin:.4rem 0}
  </style>

  <h1>Implied Odds</h1>
  <div class="card">
    <div id="rows"></div>
    <div style="display:flex;gap:.6rem;margin-top:.6rem">
      <button id="add">+ 添加项</button><button id="calc">Calculate</button>
    </div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2>结果</h2>
    <table><thead><tr><th>#</th><th>Odds</th><th>Implied</th><th>Fair Prob</th><th>Fair Odds</th></tr></thead><tbody id="tb"></tbody></table>
    <div id="ovr" style="margin-top:.6rem;color:#666"></div>
  </div>

  <script type="module">
  const $ = (id) => document.getElementById(id);

  function parseOdds(input) {
    const s = String(input || '').trim().replace(',', '.');
    if (!s) throw new Error('empty odds');
    if (/^\s*\d+\s*\/\s*\d+\s*$/.test(s)) {
      const [a, b] = s.split('/').map(Number);
      if (!b) throw new Error('invalid fractional');
      return 1 + a / b;
    }
    if (/^[+-]?\d+$/.test(s)) {
      const n = Number(s);
      if (n >= 100) return 1 + n / 100;
      if (n <= -100) return 1 + 100 / Math.abs(n);
    }
    const d = Number(s);
    if (!Number.isFinite(d) || d <= 1) throw new Error('invalid decimal odds');
    return d;
  }

  const fmtPct = (x, d = 2) => (x * 100).toFixed(d) + '%';
  const fmtOdds = (x, d = 2) => Number(x).toFixed(d);

  const impliedProb = (odds) => 1 / odds;
  function fairFromBook(oddsList) {
    const implied = oddsList.map(impliedProb);
    const sum = implied.reduce((a, b) => a + b, 0);
    const fairProb = implied.map((p) => p / sum);
    const fairOdds = fairProb.map((p) => 1 / p);
    return { fairProb, fairOdds, overround: sum - 1 };
  }

  const rows = $('rows');
  const tb = $('tb');
  const ovr = $('ovr');

  function addRow(val = '2.00') {
    const d = document.createElement('div');
    d.className = 'row';
    d.innerHTML = `<input value="${val}"/><div></div><button aria-label="删除">×</button>`;
    rows.appendChild(d);
    d.querySelector('button').addEventListener('click', () => d.remove());
  }

  $('add').addEventListener('click', () => addRow('3.00'));
  ['2.10', '3.40', '3.60'].forEach(addRow);

  function calc() {
    try {
      const odds = [...rows.querySelectorAll('input')].map((i) => parseOdds(i.value));
      const { fairProb, fairOdds, overround } = fairFromBook(odds);
      tb.innerHTML = odds
        .map(
          (o, i) =>
            `<tr><td>${i + 1}</td><td>${fmtOdds(o)}</td><td>${fmtPct(1 / o)}</td><td>${fmtPct(fairProb[i])}</td><td>${fmtOdds(fairOdds[i])}</td></tr>`
        )
        .join('');
      ovr.textContent = `Overround: ${(overround * 100).toFixed(2)}%`;
    } catch (e) {
      tb.innerHTML = '';
      ovr.textContent = 'Error: ' + String(e);
    }
  }

  $('calc').addEventListener('click', calc);
  calc();
</script>
</AppLayout>
