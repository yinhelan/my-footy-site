---
import AppLayout from '../../layouts/AppLayout.astro';
const title = 'Match Insights · Footy Analytics';
const jsonLd = { "@context":"https://schema.org","@type":"SoftwareApplication","name":"Match Insights","applicationCategory":"SportsApplication","operatingSystem":"Web","url":Astro.request.url };
import MI_URL from '../../client/match-insights.client.js?url';
---
<AppLayout title={title} description="Poisson → Fair odds → Kelly（闭环）" jsonLd={jsonLd} active="insights">
  <style>
    section, .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .mono{font-variant-numeric:tabular-nums;white-space:pre-wrap}
    label{display:block;margin:.5rem 0 .25rem} input{width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    button{padding:.6rem .9rem;border-radius:.6rem;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    h2{margin-top:1.2rem}
  </style>

  <h1>Match Insights</h1>
  <form id="f" class="card grid">
    <div>
      <label>λ(Home)</label><input id="lh" inputmode="decimal" value="1.45"/>
      <label>λ(Away)</label><input id="la" inputmode="decimal" value="1.20"/>
      <label>Max goals K（0..K）</label><input id="K" inputmode="numeric" value="8"/>
      <label>Bankroll</label><input id="bank" inputmode="decimal" value="1000"/>
      <label>单注上限（比例，默认10%）</label><input id="cap" inputmode="decimal" value="0.10"/>
    </div>
    <div>
      <label>Market odds - Home</label><input id="oh" value="2.10"/>
      <label>Market odds - Draw</label><input id="od" value="3.40"/>
      <label>Market odds - Away</label><input id="oa" value="3.60"/>
      <div style="margin-top:1rem;display:flex;gap:.6rem;flex-wrap:wrap">
        <button type="button" id="calc">Calculate</button>
        <button type="button" id="copy">复制摘要</button>
        <button type="button" id="csv">导出 Top5 CSV</button>
      </div>
    </div>
  </form>

  <section class="card"><h2>Model 1X2（Poisson ⟶ 归一）</h2>
    <div class="mono" id="modelLine"></div><div class="mono" id="fairLine"></div><div class="mono" id="tops"></div>
  </section>

  <section class="card"><h2>Market vs Model（含 Kelly）</h2>
    <div class="mono" id="marketLine"></div><div class="mono" id="kellyLine"></div>
    <small style="color:#666">当无优势时 Kelly=0；用单注上限控制 Half/Quarter Kelly。</small>
  </section>

<script type="module" src={MI_URL}></script>
</AppLayout>

<!-- lyra:tooling --><script src="/tooling.js" defer></script>
<script is:inline>
  (function () {
    const emit = (event, detail = {}) => {
      window.dispatchEvent(new CustomEvent('analytics', { detail: { event, tool: 'match-insights', ...detail } }));
    };

    emit('tool_view', { tool: 'match-insights' });

    const attach = () => {
      document.getElementById('calc')?.addEventListener('click', () => emit('match_insights_calc_click'));
      document.getElementById('copy')?.addEventListener('click', () => emit('match_insights_copy_summary'));
      document.getElementById('csv')?.addEventListener('click', () => emit('match_insights_export_top5'));
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attach, { once: true });
    } else {
      attach();
    }
  })();
</script>
<script type="module">
  const btn = document.getElementById('btn-calculate');
  btn?.addEventListener('click', () => {
    // 这里放你的计算逻辑；先来个最小演示
    try {
      // 例：从表单读入两数相加
      const a = Number((document.querySelector('[name="a"]') as HTMLInputElement)?.value || '0');
      const b = Number((document.querySelector('[name="b"]') as HTMLInputElement)?.value || '0');
      const out = document.getElementById('result') || (() => {
        const d=document.createElement('div');d.id='result'; btn.after(d); return d;
      })();
      (out as HTMLElement).textContent = `Result: ${ (a + b).toFixed(2) }`;
    } catch (e) { alert('计算失败：' + e); }
  });
</script>
