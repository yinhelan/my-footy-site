---
import AppLayout from '../../layouts/AppLayout.astro';
const title = 'Match Insights · Footy Analytics';
const jsonLd = {
  "@context":"https://schema.org","@type":"SoftwareApplication","name":"Match Insights",
  "applicationCategory":"SportsApplication","operatingSystem":"Web","url":Astro.request.url
};
---
<AppLayout title={title} description="Poisson → Fair odds → Kelly（闭环）" jsonLd={jsonLd} active="insights">
  <style>
    :root { --w: 720px; }
    section, .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .mono{font-variant-numeric:tabular-nums;white-space:pre-wrap}
    label{display:block;margin:.5rem 0 .25rem}
    input{width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    select{width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    button{padding:.6rem .9rem;border-radius:.6rem;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    h2{margin-top:1.2rem}
    .note{color:#666}
  </style>

  <h1>Match Insights</h1>
  <p class="note">已接入实时数据：从 Cloudflare Pages Functions（服务端）拉取赛程与 1X2 赔率，不在前端暴露 key。</p>

  <section class="card" style="margin-bottom:1rem">
    <h2 style="margin:0 0 .6rem">Real data（fixtures + odds）</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label>League</label>
        <select id="league" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem">
          <option value="epl">英超 Premier League</option>
          <option value="laliga">西甲 La Liga</option>
          <option value="seriea">意甲 Serie A</option>
          <option value="bundesliga">德甲 Bundesliga</option>
          <option value="ligue1">法甲 Ligue 1</option>
        </select>
        <label>Date（YYYY-MM-DD）</label><input id="date" type="date" />
        <label>Odds source</label>
        <select id="oddsSource" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem">
          <option value="odds-api">the-odds-api (h2h)</option>
          <option value="api-sports">API-Sports (1X2)</option>
        </select>
        <label>Bookmaker（可选）</label>
        <input id="bookmaker" placeholder="例如：bet365 或 api-sports bookmaker id" />
        <small class="note">赛程：football-data.org；赔率：默认 the-odds-api。Bookmaker 可留空。</small>
        <div style="margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap">
          <button id="loadFixtures" type="button">Load fixtures</button>
          <button id="loadOdds" type="button">Load odds</button>
        </div>
      </div>
      <div>
        <label>Fixture</label>
        <select id="fixture" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem"></select>
        <small class="note">选择比赛后点 “Load odds”，会自动回填右侧 Market odds。</small>
        <div class="mono" id="dataStatus" style="margin-top:.6rem"></div>
      </div>
    </div>
  </section>

  <form id="f" class="card grid" onsubmit="return false;">
    <div>
      <label>λ(Home)</label><input id="lh" inputmode="decimal" value="1.45"/>
      <label>λ(Away)</label><input id="la" inputmode="decimal" value="1.20"/>
      <label>Max goals K（0..K）</label><input id="K" inputmode="numeric" value="8"/>
      <label>Bankroll</label><input id="bank" inputmode="decimal" value="1000"/>
      <label>单注上限（比例，默认10%）</label><input id="cap" inputmode="decimal" value="0.10"/>
    </div>
    <div>
      <label>Market odds - Home</label><input id="oh" value="2.10"/>
      <label>Market odds - Draw</label><input id="od" value="3.40"/>
      <label>Market odds - Away</label><input id="oa" value="3.60"/>
      <div style="margin-top:1rem;display:flex;gap:.6rem;flex-wrap:wrap">
        <button id="calc">Calculate</button><button id="copy">复制摘要</button><button id="csv">导出 Top5 CSV</button>
      </div>
    </div>
  </form>

  <section class="card"><h2>Model 1X2（Poisson ⟶ 归一）</h2>
    <div class="mono" id="modelLine"></div><div class="mono" id="fairLine"></div><div class="mono" id="tops"></div>
  </section>

  <section class="card"><h2>Market vs Model（含 Kelly）</h2>
    <div class="mono" id="marketLine"></div><div class="mono" id="kellyLine"></div>
    <small class="note">当无优势时 Kelly=0；用单注上限控制 Half/Quarter Kelly。</small>
  </section>

  <script type="module">
    import { initMatchInsights } from "../../scripts/match-insights";
    initMatchInsights();
  </script>
</AppLayout>
