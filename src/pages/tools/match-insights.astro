---
import AppLayout from '../../layouts/AppLayout.astro';
const title = 'Match Insights · Footy Analytics';
const jsonLd = {
  "@context":"https://schema.org","@type":"SoftwareApplication","name":"Match Insights",
  "applicationCategory":"SportsApplication","operatingSystem":"Web","url":Astro.request.url
};
---
<AppLayout title={title} description="Poisson → Fair odds → Kelly（闭环）" jsonLd={jsonLd} active="insights">
  <style>
    :root { --w: 720px; }
    section, .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .mono{font-variant-numeric:tabular-nums;white-space:pre-wrap}
    label{display:block;margin:.5rem 0 .25rem}
    input{width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    select{width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    button{padding:.6rem .9rem;border-radius:.6rem;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    h2{margin-top:1.2rem}
    .note{color:#666}
  </style>

  <h1>Match Insights</h1>
  <p class="note">已接入实时数据：从 Cloudflare Pages Functions（服务端）拉取赛程与 1X2 赔率，不在前端暴露 key。</p>

  <section class="card" style="margin-bottom:1rem">
    <h2 style="margin:0 0 .6rem">Real data（fixtures + odds）</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label>League</label>
        <select id="league" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem">
          <option value="epl">英超 Premier League</option>
          <option value="laliga">西甲 La Liga</option>
          <option value="seriea">意甲 Serie A</option>
          <option value="bundesliga">德甲 Bundesliga</option>
          <option value="ligue1">法甲 Ligue 1</option>
        </select>
        <label>Date（YYYY-MM-DD）</label><input id="date" type="date" />
        <label>Odds source</label>
        <select id="oddsSource" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem">
          <option value="odds-api">the-odds-api (h2h)</option>
          <option value="api-sports">API-Sports (1X2)</option>
        </select>
        <label>Bookmaker（可选）</label>
        <input id="bookmaker" placeholder="例如：bet365 或 api-sports bookmaker id" />
        <small class="note">赛程：football-data.org；赔率：默认 the-odds-api。Bookmaker 可留空。</small>
        <div style="margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap">
          <button id="loadFixtures" type="button">Load fixtures</button>
          <button id="loadOdds" type="button">Load odds</button>
        </div>
      </div>
      <div>
        <label>Fixture</label>
        <select id="fixture" style="width:100%;padding:.5rem .6rem;border:1px solid #ddd;border-radius:.5rem"></select>
        <small class="note">选择比赛后点 “Load odds”，会自动回填右侧 Market odds。</small>
        <div class="mono" id="dataStatus" style="margin-top:.6rem"></div>
      </div>
    </div>
  </section>

  <form id="f" class="card grid" onsubmit="return false;">
    <div>
      <label>λ(Home)</label><input id="lh" inputmode="decimal" value="1.45"/>
      <label>λ(Away)</label><input id="la" inputmode="decimal" value="1.20"/>
      <label>Max goals K（0..K）</label><input id="K" inputmode="numeric" value="8"/>
      <label>Bankroll</label><input id="bank" inputmode="decimal" value="1000"/>
      <label>单注上限（比例，默认10%）</label><input id="cap" inputmode="decimal" value="0.10"/>
    </div>
    <div>
      <label>Market odds - Home</label><input id="oh" value="2.10"/>
      <label>Market odds - Draw</label><input id="od" value="3.40"/>
      <label>Market odds - Away</label><input id="oa" value="3.60"/>
      <div style="margin-top:1rem;display:flex;gap:.6rem;flex-wrap:wrap">
        <button id="calc">Calculate</button><button id="copy">复制摘要</button><button id="csv">导出 Top5 CSV</button>
      </div>
    </div>
  </form>

  <section class="card"><h2>Model 1X2（Poisson ⟶ 归一）</h2>
    <div class="mono" id="modelLine"></div><div class="mono" id="fairLine"></div><div class="mono" id="tops"></div>
  </section>

  <section class="card"><h2>Market vs Model（含 Kelly）</h2>
    <div class="mono" id="marketLine"></div><div class="mono" id="kellyLine"></div>
    <small class="note">当无优势时 Kelly=0；用单注上限控制 Half/Quarter Kelly。</small>
  </section>

  <script type="module">
    import { parseOdds, fairFromBook, fmtPct, fmtOdds } from '../../lib/odds.ts';
    import { scoreMatrix, probs1x2, topScorelines } from '../../lib/poisson.ts';
    import { kellyFrac, stake } from '../../lib/kelly.ts';
    import { copy as copyTxt, downloadCSV } from '../../lib/share.ts';
    const $ = (id)=>document.getElementById(id), toNumber=(s)=>Number(String(s).replace(',', '.'));

    function setStatus(s){ $('dataStatus').textContent = s || ''; }

    function todayShanghaiISO(){
      // Avoid timezone confusion: use user's local date picker default
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    async function loadFixtures(){
      const leagueKey = $('league').value;
      const date = $('date').value;
      setStatus('Loading fixtures...');
      $('fixture').innerHTML = '';

      const LEAGUES = {
        epl: { footballData: 'PL', oddsApiSport: 'soccer_epl' },
        laliga: { footballData: 'PD', oddsApiSport: 'soccer_spain_la_liga' },
        seriea: { footballData: 'SA', oddsApiSport: 'soccer_italy_serie_a' },
        bundesliga: { footballData: 'BL1', oddsApiSport: 'soccer_germany_bundesliga' },
        ligue1: { footballData: 'FL1', oddsApiSport: 'soccer_france_ligue_one' },
      };
      const cfg = LEAGUES[leagueKey];
      if (!cfg) { setStatus('Unknown league'); return; }

      const u = new URL('/api/football-data/matches', window.location.origin);
      u.searchParams.set('competition', cfg.footballData);
      u.searchParams.set('dateFrom', date);
      u.searchParams.set('dateTo', date);

      const r = await fetch(u);
      const j = await r.json();
      if (!r.ok) { setStatus(`Fixtures error: ${r.status} ${JSON.stringify(j)}`); return; }

      const list = (j?.matches || []).map((m)=>{
        const id = m?.id;
        const dt = m?.utcDate;
        const home = m?.homeTeam?.name;
        const away = m?.awayTeam?.name;
        const status = m?.status;
        return { id, label: `${home} vs ${away} · ${dt} · ${status}`, meta: { utcDate: dt, home, away, leagueKey } };
      }).filter(x=>x.id);

      // store meta for odds matching
      window.__fixturesMeta = Object.fromEntries(list.map(x=>[String(x.id), x.meta]));

      if (!list.length){ setStatus('No fixtures found for this date/league/season.'); return; }

      list.forEach((x,i)=>{
        const opt = document.createElement('option');
        opt.value = String(x.id);
        opt.textContent = x.label;
        if (i===0) opt.selected = true;
        $('fixture').appendChild(opt);
      });

      setStatus(`Fixtures loaded: ${list.length}`);
    }

    function normTeam(s){
      return String(s||'')
        .toLowerCase()
        .replace(/\b(fc|cf|sc|afc)\b/g,'')
        .replace(/[^a-z0-9\u4e00-\u9fa5]+/g,' ')
        .trim();
    }

    function pickH2HOddsFromOddsApi(events, meta){
      // events: array of odds-api events with bookmakers->markets[h2h]
      const targetHome = normTeam(meta.home);
      const targetAway = normTeam(meta.away);
      const targetDate = String(meta.utcDate||'').slice(0,10);

      const candidates = (events||[]).filter(ev=>{
        const h = normTeam(ev?.home_team);
        const a = normTeam(ev?.away_team);
        const d = String(ev?.commence_time||'').slice(0,10);
        const sameTeams = (h===targetHome && a===targetAway) || (h===targetAway && a===targetHome);
        return sameTeams && (!targetDate || d===targetDate);
      });
      const ev = candidates[0];
      if (!ev) return null;

      const wantedBook = String($('bookmaker')?.value||'').toLowerCase().trim();
      const bms = ev.bookmakers || [];
      const bm = wantedBook ? bms.find(b=>String(b.key||'').toLowerCase()===wantedBook || String(b.title||'').toLowerCase().includes(wantedBook)) : bms[0];
      if (!bm) return null;

      const mkt = (bm.markets||[]).find(m=>m.key==='h2h');
      if (!mkt) return null;

      const outs = mkt.outcomes || [];
      const getPrice = (name)=>{
        const hit = outs.find(o=>String(o.name||'').toLowerCase()===String(name||'').toLowerCase());
        const p = hit ? Number(hit.price) : NaN;
        return Number.isFinite(p) ? p : null;
      };

      const homeP = getPrice(ev.home_team);
      const awayP = getPrice(ev.away_team);
      const drawP = getPrice('Draw') ?? getPrice('draw');

      if (!homeP || !awayP || !drawP) return null;
      return { home: homeP, draw: drawP, away: awayP, bookmaker: bm.title || bm.key };
    }

    async function loadOdds(){
      const matchId = $('fixture').value;
      if (!matchId){ setStatus('Pick a fixture first.'); return; }
      const meta = window.__fixturesMeta?.[String(matchId)];
      if (!meta){ setStatus('Missing fixture meta; reload fixtures.'); return; }

      const LEAGUES = {
        epl: { oddsApiSport: 'soccer_epl' },
        laliga: { oddsApiSport: 'soccer_spain_la_liga' },
        seriea: { oddsApiSport: 'soccer_italy_serie_a' },
        bundesliga: { oddsApiSport: 'soccer_germany_bundesliga' },
        ligue1: { oddsApiSport: 'soccer_france_ligue_one' },
      };
      const cfg = LEAGUES[meta.leagueKey];
      if (!cfg) { setStatus('Unknown league for odds'); return; }

      const oddsSource = $('oddsSource')?.value || 'odds-api';
      setStatus(`Loading odds (${oddsSource})...`);

      if (oddsSource === 'odds-api'){
        const u = new URL('/api/odds/odds', window.location.origin);
        u.searchParams.set('sport', cfg.oddsApiSport);
        u.searchParams.set('regions', 'eu');
        u.searchParams.set('markets', 'h2h');
        u.searchParams.set('oddsFormat', 'decimal');
        u.searchParams.set('dateFormat', 'iso');
        // optional bookmakers filter (comma-separated keys) could be added later

        const r = await fetch(u);
        const j = await r.json();
        if (!r.ok) { setStatus(`Odds error: ${r.status} ${JSON.stringify(j)}`); return; }

        const pick = pickH2HOddsFromOddsApi(j, meta);
        if (!pick){
          setStatus('Odds loaded but could not match event or find h2h 1X2. Try another date/league or leave bookmaker empty.');
          return;
        }

        $('oh').value = String(pick.home);
        $('od').value = String(pick.draw);
        $('oa').value = String(pick.away);
        setStatus(`Odds OK (${pick.bookmaker}) → filled Market odds.`);
        calc();
        return;
      }

      // Fallback: API-Sports odds requires fixture-id mapping; not wired in this path yet.
      setStatus('API-Sports odds mapping from football-data match → api-sports fixture is not implemented yet. Use the-odds-api for now.');
    }

    function calc(){
      const lh=toNumber($('lh').value), la=toNumber($('la').value), K=Math.max(0, parseInt($('K').value||'8'));
      const bank=toNumber($('bank').value), cap=toNumber($('cap').value||'0.10')||0.10;
      const oh=parseOdds($('oh').value), od=parseOdds($('od').value), oa=parseOdds($('oa').value);
      const { mat } = scoreMatrix(lh, la, K); const model = probs1x2(mat); const fair = {H:1/model.H,D:1/model.D,A:1/model.A};
      $('modelLine').textContent=`Model prob  H ${fmtPct(model.H)} · D ${fmtPct(model.D)} · A ${fmtPct(model.A)}`;
      $('fairLine').textContent =`Model fair  H ${fmtOdds(fair.H)} · D ${fmtOdds(fair.D)} · A ${fmtOdds(fair.A)}`;
      const tops = topScorelines(mat,5).map(x=>`Home ${x.h}-${x.a} Away ${fmtPct(x.p)}`).join('\n');
      $('tops').textContent='Top scorelines\n'+tops;
      const { overround } = fairFromBook([oh,od,oa]);
      $('marketLine').textContent=`Market odds  H ${fmtOdds(oh)} · D ${fmtOdds(od)} · A ${fmtOdds(oa)}   Overround ${(overround*100).toFixed(2)}%`;
      const kH=stake(bank,kellyFrac(model.H,oh),cap), kD=stake(bank,kellyFrac(model.D,od),cap), kA=stake(bank,kellyFrac(model.A,oa),cap);
      $('kellyLine').textContent=`Kelly stake(¥)  H ${kH.toFixed(2)} · D ${kD.toFixed(2)} · A ${kA.toFixed(2)}   (cap ${(cap*100).toFixed(0)}%)`;
      return { lh,la,K,bank,cap,oh,od,oa,model,overround,topsArr: topScorelines(mat,5) };
    }

    $('loadFixtures').addEventListener('click',()=>loadFixtures().catch(e=>setStatus(String(e))));
    $('loadOdds').addEventListener('click',()=>loadOdds().catch(e=>setStatus(String(e))));
    $('calc').addEventListener('click',()=>calc());
    $('copy').addEventListener('click',async()=>{ const r=calc(); const text=[
      `λ(H)=${r.lh}, λ(A)=${r.la}, K=${r.K}`,
      `Model prob H ${fmtPct(r.model.H)} · D ${fmtPct(r.model.D)} · A ${fmtPct(r.model.A)}`,
      `Market odds H ${fmtOdds(r.oh)} · D ${fmtOdds(r.od)} · A ${fmtOdds(r.oa)} · Overround ${(r.overround*100).toFixed(2)}%`,
      'Top scorelines: '+r.topsArr.map(x=>`${x.h}-${x.a} ${fmtPct(x.p)}`).join(', ')
    ].join('\n'); await copyTxt(text); alert('已复制摘要'); });
    $('csv').addEventListener('click',()=>{ const r=calc(); const rows=[['home','away','prob']]; r.topsArr.forEach(x=>rows.push([x.h,x.a,(x.p*100).toFixed(2)+'%'])); downloadCSV('top-scorelines.csv',rows); });

    // Init
    $('date').value = todayShanghaiISO();
    $('fixture').innerHTML = '<option value="">(load fixtures first)</option>';
    calc();
  </script>
</AppLayout>
