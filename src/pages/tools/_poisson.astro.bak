---
const style = `
  *{box-sizing:border-box} .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 260px} input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer}
  .btn{background:#111;color:#fff} .card{border:1px solid #eee;border-radius:12px;padding:14px}
  table{border-collapse:collapse;width:100%} td,th{border:1px solid #eee;padding:6px;text-align:center}
`;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Poisson Scoreline & BTTS/OU Calculator</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style is:global set:html={style}></style>
  </head>
  <body style="font-family: system-ui; max-width: 960px; margin: 24px auto; padding: 0 16px;">
    <h1>Poisson Scoreline & BTTS/OU Calculator</h1>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>λ (Home)</label>
          <input id="lamHome" type="number" step="0.01" min="0" placeholder="1.40" />
        </div>
        <div class="col">
          <label>λ (Away)</label>
          <input id="lamAway" type="number" step="0.01" min="0" placeholder="1.10" />
        </div>
        <div class="col">
          <label>Max goals (0..K)</label>
          <input id="kMax" type="number" step="1" min="4" value="6" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="calcBtn">Calculate</button>
        <button id="copyBtn">Copy Summary</button>
        <button id="csvBtn">Export CSV</button>
      </div>
    </div>

    <div id="result" style="margin-top:16px; display:none">
      <div class="row">
        <div class="col card">
          <h3>Overview</h3>
          <div id="overview"></div>
        </div>
        <div class="col card">
          <h3>Top 5 Scorelines</h3>
          <ol id="top5"></ol>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>Full Score Matrix</h3>
        <div id="matrix"></div>
      </div>
    </div>

    <script>
      const factMemo = {0:1};
      function factorial(n){ if(factMemo[n]) return factMemo[n]; let r=1; for(let i=2;i<=n;i++) r*=i; factMemo[n]=r; return r; }
      function pois(k, lam){ if(lam<=0 && k===0) return 1; if(lam<=0) return 0; return Math.exp(-lam) * Math.pow(lam, k) / factorial(k); }
      function buildPmf(lam, kMax){ const arr=[]; for(let k=0;k<=kMax;k++) arr.push(pois(k, lam)); const s=arr.reduce((a,b)=>a+b,0); return arr.map(x=>x/s); }

      function compute(){
        const lamH = parseFloat(document.getElementById('lamHome').value);
        const lamA = parseFloat(document.getElementById('lamAway').value);
        const kMax = parseInt(document.getElementById('kMax').value,10);
        if(isNaN(lamH) || isNaN(lamA) || isNaN(kMax) || lamH<0 || lamA<0 || kMax<1){ alert('Please enter valid numbers.'); return; }

        const pmfH = buildPmf(lamH, kMax);
        const pmfA = buildPmf(lamA, kMax);

        const M = [];
        for(let i=0;i<=kMax;i++){ const row=[]; for(let j=0;j<=kMax;j++){ row.push(pmfH[i]*pmfA[j]); } M.push(row); }

        const sumRow0 = M[0].reduce((a,b)=>a+b,0);
        let sumCol0 = 0; for(let i=0;i<=kMax;i++) sumCol0 += M[i][0];
        const BTTS = 1 - (sumCol0 + sumRow0 - M[0][0]);

        let over = 0;
        for(let i=0;i<=kMax;i++){ for(let j=0;j<=kMax;j++){ if(i+j>=3) over += M[i][j]; } }
        const under = 1 - over;

        const flat=[]; for(let i=0;i<=kMax;i++){ for(let j=0;j<=kMax;j++){ flat.push({i,j,p:M[i][j]}); } }
        flat.sort((a,b)=>b.p-a.p); const top5 = flat.slice(0,5);

        const pct = (x)=> (x*100).toFixed(2) + '%';
        document.getElementById('overview').innerHTML = `
          <p><b>BTTS</b>: ${pct(BTTS)}</p>
          <p><b>Over 2.5</b>: ${pct(over)}</p>
          <p><b>Under 2.5</b>: ${pct(under)}</p>
          <p style="color:#666">Assumptions: independence; truncation at K=${kMax}</p>`;

        document.getElementById('top5').innerHTML = top5.map(t=>`<li>${t.i}:${t.j} — ${pct(t.p)}</li>`).join('');

        let html = '<table><thead><tr><th>H\\A</th>';
        for(let j=0;j<=kMax;j++) html += '<th>'+j+'</th>';
        html += '</tr></thead><tbody>';
        for(let i=0;i<=kMax;i++){ html += '<tr><th>'+i+'</th>'; for(let j=0;j<=kMax;j++){ html += '<td>'+pct(M[i][j])+'</td>'; } html += '</tr>'; }
        html += '</tbody></table>';
        document.getElementById('matrix').innerHTML = html;

        window.__lastResult = { lamH, lamA, kMax, BTTS, over, under, matrix: M, top5 };
        document.getElementById('result').style.display = 'block';
      }

      function copySummary(){
        const r = window.__lastResult; if(!r){ alert('Calculate first.'); return; }
        const fmt = (x)=> (x*100).toFixed(2)+'%';
        const text = `Poisson Summary
λ_home=${r.lamH}, λ_away=${r.lamA}, K=${r.kMax}
BTTS=${fmt(r.BTTS)} | Over2.5=${fmt(r.over)} | Under2.5=${fmt(r.under)}
Top5: ${r.top5.map(t=>`${t.i}:${t.j} ${fmt(t.p)}`).join(', ')}`;
        navigator.clipboard.writeText(text).then(()=>alert('Copied!'));
      }

      function exportCSV(){
        const r = window.__lastResult; if(!r){ alert('Calculate first.'); return; }
        let csv = 'home,away,prob\\n';
        for(let i=0;i<=r.kMax;i++){ for(let j=0;j<=r.kMax;j++){ csv += `${i},${j},${r.matrix[i][j].toFixed(6)}\\n`; } }
        const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'poisson_matrix.csv'; a.click(); URL.revokeObjectURL(url);
      }

      document.getElementById('calcBtn').addEventListener('click', compute);
      document.getElementById('copyBtn').addEventListener('click', copySummary);
      document.getElementById('csvBtn').addEventListener('click', exportCSV);
    </script>
  </body>
</html>
