---
import AppLayout from '../layouts/AppLayout.astro';
const title = 'Match · Footy Analytics';
const jsonLd = {"@context":"https://schema.org","@type":"WebPage","name":"Match","url":Astro.request.url};
const fid = Astro.url.searchParams.get('fid') ?? '';
const league = Astro.url.searchParams.get('league') ?? 'epl';
const season = Astro.url.searchParams.get('season') ?? '';
---
<AppLayout title={title} description="比赛详情：亚盘水位/赢盘概率/相似比赛（迭代中）" jsonLd={jsonLd} active="home">
  <style>
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    input,select{width:100%;padding:.55rem .7rem;border:1px solid #ddd;border-radius:.6rem}
    button{padding:.55rem .8rem;border:1px solid #ddd;border-radius:.6rem;background:#fafafa;cursor:pointer}
    .mono{font-variant-numeric:tabular-nums;white-space:pre-wrap}
    .note{color:#666}
    table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
  </style>

  <h1>Match detail</h1>

  <div class="card grid">
    <div>
      <label class="note">fid（football-data matchId）</label>
      <input id="fid" value={fid} placeholder="例如：1234567" />
    </div>
    <div>
      <label class="note">League key（用于 API-Sports 映射）</label>
      <select id="league">
        <option value="epl" selected={league==='epl'}>epl 英超</option>
        <option value="laliga" selected={league==='laliga'}>laliga 西甲</option>
        <option value="seriea" selected={league==='seriea'}>seriea 意甲</option>
        <option value="bundesliga" selected={league==='bundesliga'}>bundesliga 德甲</option>
        <option value="ligue1" selected={league==='ligue1'}>ligue1 法甲</option>
      </select>
    </div>
    <div>
      <label class="note">比赛日期（用于从 matches 列表解析 meta）</label>
      <input id="date" type="date" />
    </div>
    <div>
      <label class="note">API-Sports season（可不填；会自动回退 2024→2023→2022）</label>
      <input id="season" value={season} placeholder="例如：2024" />
    </div>
    <div style="display:flex;gap:.6rem;align-items:end;flex-wrap:wrap">
      <button id="loadMeta">加载比赛信息</button>
      <button id="snap">抓取亚盘快照</button>
      <button id="list">查看历史快照</button>
    </div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">比赛信息</h2>
    <div class="mono" id="meta"></div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">让球盘 Spreads（The Odds API）</h2>
    <div class="note">当前版本：抓取 spreads(让球) 快照 + 去水后的赢盘概率（市场隐含概率）。默认 bookmaker=Pinnacle。趋势图/大小球/相似比赛下一步补。</div>
    <div class="mono" id="ah"></div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">快照列表</h2>
    <table>
      <thead><tr><th>time</th><th>source</th><th>league</th><th>bookmaker</th><th>line</th><th>home</th><th>away</th></tr></thead>
      <tbody id="tb"></tbody>
    </table>
  

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">盘口趋势（point）</h2>
    <div class="note">从 D1 快照序列绘制 spreads 的 point（让球盘）随时间变化（越负=让得越深）。</div>
    <div id="chartWrap" style="width:100%;overflow:auto">
      <svg id="chart" width="720" height="220" viewBox="0 0 720 220" style="border:1px solid #eee;border-radius:12px;background:#fff"></svg>
    </div>
    <div class="note" id="chartHint" style="margin-top:.6rem"></div>
  </div>
</div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    function set(el, s){ el.textContent = s || ''; }
    function jfmt(x){ return JSON.stringify(x, null, 2); }


    function parseIso(s){ const t=Date.parse(s); return Number.isFinite(t)?t:null; }
    function fmtTime(iso){ try{ const d=new Date(iso); const p=n=>String(n).padStart(2,'0'); return `${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }catch{ return iso; } }

    function drawPointChart(rows){
      const svg=$('chart');
      const hint=$('chartHint');
      if(!svg) return;

      const pts = (rows||[]).map(r=>{
        const t=parseIso(r.created_at);
        const p=r.spreads && r.spreads.home ? Number(r.spreads.home.point) : NaN;
        return {t, p, iso:r.created_at};
      }).filter(x=>x.t && Number.isFinite(x.p)).sort((a,b)=>a.t-b.t);

      if(pts.length<2){
        svg.innerHTML = `<text x="16" y="30" fill="#666" font-size="14">快照不足（至少需要 2 个点）</text>`;
        hint.textContent = pts.length===1 ? `当前仅 1 个点：${fmtTime(pts[0].iso)}  point=${pts[0].p}` : '';
        return;
      }

      const W=720,H=220,padL=48,padR=16,padT=16,padB=34;
      const minT=Math.min(...pts.map(x=>x.t));
      const maxT=Math.max(...pts.map(x=>x.t));
      let minP=Math.min(...pts.map(x=>x.p));
      let maxP=Math.max(...pts.map(x=>x.p));
      if(minP===maxP){ minP-=0.5; maxP+=0.5; }

      const x = (t)=> padL + ( (t-minT) / (maxT-minT) ) * (W-padL-padR);
      const y = (p)=> padT + ( (maxP-p) / (maxP-minP) ) * (H-padT-padB);

      // grid + axes
      const gridY = 4;
      let g='';
      for(let i=0;i<=gridY;i++){
        const yy = padT + i*(H-padT-padB)/gridY;
        const pv = (maxP - i*(maxP-minP)/gridY);
        g += `<line x1="${padL}" y1="${yy}" x2="${W-padR}" y2="${yy}" stroke="#f2f2f2"/>`;
        g += `<text x="${padL-8}" y="${yy+4}" text-anchor="end" fill="#888" font-size="12">${pv.toFixed(2)}</text>`;
      }
      g += `<line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="#ddd"/>`;
      g += `<line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="#ddd"/>`;

      // step-like path
      let d='';
      for(let i=0;i<pts.length;i++){
        const xi=x(pts[i].t), yi=y(pts[i].p);
        if(i===0){ d += `M ${xi} ${yi}`; }
        else{
          const xPrev=x(pts[i-1].t), yPrev=y(pts[i-1].p);
          // horizontal then vertical (step)
          d += ` L ${xi} ${yPrev} L ${xi} ${yi}`;
        }
      }
      const path = `<path d="${d}" fill="none" stroke="#111" stroke-width="2"/>`;

      // points
      const dots = pts.map(p=>`<circle cx="${x(p.t)}" cy="${y(p.p)}" r="3" fill="#111"/>`).join('');

      // x labels (first/last)
      const xlab = `
        <text x="${padL}" y="${H-10}" fill="#888" font-size="12">${fmtTime(new Date(minT).toISOString())}</text>
        <text x="${W-padR}" y="${H-10}" text-anchor="end" fill="#888" font-size="12">${fmtTime(new Date(maxT).toISOString())}</text>
      `;

      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
      svg.setAttribute('width', String(Math.max(720, pts.length*40)));
      svg.innerHTML = g + path + dots + xlab;

      hint.textContent = `point范围：${minP.toFixed(2)} ～ ${maxP.toFixed(2)}；点数：${pts.length}`;
    }

    const LEAGUE_COMP = { epl: 'PL', laliga: 'PD', seriea: 'SA', bundesliga: 'BL1', ligue1: 'FL1' };
    function todayISO(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    async function loadMeta(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const leagueKey=$('league').value;
      const comp=LEAGUE_COMP[leagueKey];
      const date=$('date').value || todayISO();

      const u=new URL('/api/football-data/matches', location.origin);
      u.searchParams.set('competition', comp);
      u.searchParams.set('dateFrom', date);
      u.searchParams.set('dateTo', date);
      const r=await fetch(u);
      const j=await r.json();
      if(!r.ok){ set($('meta'), `error: ${r.status}\n`+jfmt(j)); return; }

      const m=(j.matches||[]).find(x=>String(x.id)===String(id));
      if(!m){
        set($('meta'), `未在 ${comp} ${date} 的 matches 列表里找到 id=${id}。\n你可以改一下日期再试。`);
        return;
      }

      const line=[
        `id: ${id}`,
        `utcDate: ${m.utcDate}`,
        `competition: ${m.competition?.code} ${m.competition?.name}`,
        `home: ${m.homeTeam?.name}`,
        `away: ${m.awayTeam?.name}`,
        `status: ${m.status}`,
      ].join('\n');
      set($('meta'), line);
      return m;
    }

    async function snapshotAH(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const league=$('league').value;

      const meta = await loadMeta();
      if(!meta) return;

      const u=new URL('/api/track/snapshot_spreads', location.origin);
      u.searchParams.set('matchId', id);
      u.searchParams.set('leagueKey', league);
      u.searchParams.set('utcDate', meta.utcDate);
      u.searchParams.set('home', meta.homeTeam?.name || '');
      u.searchParams.set('away', meta.awayTeam?.name || '');

      const r=await fetch(u, {method:'POST'});
      const j=await r.json();
      if(!r.ok){ set($('ah'), `error: ${r.status}\n`+jfmt(j)); return; }

      const sp = j.spreads;
      if (!sp) { set($('ah'), jfmt(j)); return; }

      const lines = [
        `bookmaker: ${sp.bookmaker || ''} (${sp.key||''})`,
        `market: spreads`,
        `time: ${sp.event?.commence_time || ''}`,
        `home: ${sp.home?.team}  point ${sp.home?.point}  price ${sp.home?.price}`,
        `away: ${sp.away?.team}  point ${sp.away?.point}  price ${sp.away?.price}`,
        sp.implied ? `no-vig p(home): ${(sp.implied.pA*100).toFixed(2)}%  p(away): ${(sp.implied.pB*100).toFixed(2)}%  overround: ${(sp.implied.overround*100).toFixed(2)}%` : '',
      ].filter(Boolean).join('\n');

      set($('ah'), lines + '\n\n' + jfmt(sp));
    }

    async function listSnapshots(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const u=new URL('/api/track/snapshots_spreads', location.origin);
      u.searchParams.set('matchId', id);
      const r=await fetch(u);
      const j=await r.json();
      if(!r.ok){ $('tb').innerHTML = `<tr><td colspan="7">error: ${r.status} ${jfmt(j)}</td></tr>`; return; }
      const rows=j.rows||[];
      drawPointChart(rows);
      $('tb').innerHTML = rows.map(x=>{
        const sp=x.spreads||null;
        const line=sp? (sp.home?.point ?? '') : '';
        const h=sp? (sp.home?.price ?? '') : '';
        const a=sp? (sp.away?.price ?? '') : '';
        const bm=(sp && (sp.bookmaker||sp.key)) ? (sp.bookmaker||sp.key) : (x.bookmaker_id||'');
        return `<tr><td>${x.created_at}</td><td>${x.source}</td><td>${x.league_key||''}</td><td>${bm||''}</td><td>${line}</td><td>${h}</td><td>${a}</td></tr>`;
      }).join('');
    }

    $('loadMeta').addEventListener('click', ()=>loadMeta().catch(e=>set($('meta'), String(e))));
    $('snap').addEventListener('click', ()=>snapshotAH().catch(e=>set($('ah'), String(e))));
    $('list').addEventListener('click', ()=>listSnapshots().catch(e=>$('tb').innerHTML=`<tr><td colspan="7">${String(e)}</td></tr>`));

    // init
    $('date').value = $('date').value || todayISO();

    // auto-load if fid present
    if(String($('fid').value||'').trim()) loadMeta().catch(()=>{});
  </script>
</AppLayout>
