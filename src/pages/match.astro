---
import AppLayout from '../layouts/AppLayout.astro';
const title = 'Match · Footy Analytics';
const jsonLd = {"@context":"https://schema.org","@type":"WebPage","name":"Match","url":Astro.request.url};
const fid = Astro.url.searchParams.get('fid') ?? '';
const league = Astro.url.searchParams.get('league') ?? 'epl';
const season = Astro.url.searchParams.get('season') ?? '';
---
<AppLayout title={title} description="比赛详情：亚盘水位/赢盘概率/相似比赛（迭代中）" jsonLd={jsonLd} active="home">
  <style>
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    input,select{width:100%;padding:.55rem .7rem;border:1px solid #ddd;border-radius:.6rem}
    button{padding:.55rem .8rem;border:1px solid #ddd;border-radius:.6rem;background:#fafafa;cursor:pointer}
    .mono{font-variant-numeric:tabular-nums;white-space:pre-wrap}
    .note{color:#666}
    table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
  </style>

  <h1>Match detail</h1>

  <div class="card grid">
    <div>
      <label class="note">fid（football-data matchId）</label>
      <input id="fid" value={fid} placeholder="例如：1234567" />
    </div>
    <div>
      <label class="note">League key（用于 API-Sports 映射）</label>
      <select id="league">
        <option value="epl" selected={league==='epl'}>epl 英超</option>
        <option value="laliga" selected={league==='laliga'}>laliga 西甲</option>
        <option value="seriea" selected={league==='seriea'}>seriea 意甲</option>
        <option value="bundesliga" selected={league==='bundesliga'}>bundesliga 德甲</option>
        <option value="ligue1" selected={league==='ligue1'}>ligue1 法甲</option>
      </select>
    </div>
    <div>
      <label class="note">比赛日期（用于从 matches 列表解析 meta）</label>
      <input id="date" type="date" />
    </div>
    <div>
      <label class="note">API-Sports season（可不填；会自动回退 2024→2023→2022）</label>
      <input id="season" value={season} placeholder="例如：2024" />
    </div>
    <div style="display:flex;gap:.6rem;align-items:end;flex-wrap:wrap">
      <button id="loadMeta">加载比赛信息</button>
      <button id="snap">抓取亚盘快照</button>
      <button id="list">查看历史快照</button>
    </div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">比赛信息</h2>
    <div class="mono" id="meta"></div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">让球盘 Spreads（The Odds API）</h2>
    <div class="note">当前版本：抓取 spreads(让球) 快照 + 去水后的赢盘概率（市场隐含概率）。默认 bookmaker=Pinnacle。趋势图/大小球/相似比赛下一步补。</div>
    <div class="mono" id="ah"></div>
  </div>

  <div class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">快照列表</h2>
    <table>
      <thead><tr><th>time</th><th>source</th><th>league</th><th>bookmaker</th><th>line</th><th>home</th><th>away</th></tr></thead>
      <tbody id="tb"></tbody>
    </table>
  </div>

  <script type="module">
    const $ = (id)=>document.getElementById(id);
    function set(el, s){ el.textContent = s || ''; }
    function jfmt(x){ return JSON.stringify(x, null, 2); }

    const LEAGUE_COMP = { epl: 'PL', laliga: 'PD', seriea: 'SA', bundesliga: 'BL1', ligue1: 'FL1' };
    function todayISO(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    async function loadMeta(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const leagueKey=$('league').value;
      const comp=LEAGUE_COMP[leagueKey];
      const date=$('date').value || todayISO();

      const u=new URL('/api/football-data/matches', location.origin);
      u.searchParams.set('competition', comp);
      u.searchParams.set('dateFrom', date);
      u.searchParams.set('dateTo', date);
      const r=await fetch(u);
      const j=await r.json();
      if(!r.ok){ set($('meta'), `error: ${r.status}\n`+jfmt(j)); return; }

      const m=(j.matches||[]).find(x=>String(x.id)===String(id));
      if(!m){
        set($('meta'), `未在 ${comp} ${date} 的 matches 列表里找到 id=${id}。\n你可以改一下日期再试。`);
        return;
      }

      const line=[
        `id: ${id}`,
        `utcDate: ${m.utcDate}`,
        `competition: ${m.competition?.code} ${m.competition?.name}`,
        `home: ${m.homeTeam?.name}`,
        `away: ${m.awayTeam?.name}`,
        `status: ${m.status}`,
      ].join('\n');
      set($('meta'), line);
      return m;
    }

    async function snapshotAH(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const league=$('league').value;

      const meta = await loadMeta();
      if(!meta) return;

      const u=new URL('/api/track/snapshot_spreads', location.origin);
      u.searchParams.set('matchId', id);
      u.searchParams.set('leagueKey', league);
      u.searchParams.set('utcDate', meta.utcDate);
      u.searchParams.set('home', meta.homeTeam?.name || '');
      u.searchParams.set('away', meta.awayTeam?.name || '');

      const r=await fetch(u, {method:'POST'});
      const j=await r.json();
      if(!r.ok){ set($('ah'), `error: ${r.status}\n`+jfmt(j)); return; }

      const sp = j.spreads;
      if (!sp) { set($('ah'), jfmt(j)); return; }

      const lines = [
        `bookmaker: ${sp.bookmaker || ''} (${sp.key||''})`,
        `market: spreads`,
        `time: ${sp.event?.commence_time || ''}`,
        `home: ${sp.home?.team}  point ${sp.home?.point}  price ${sp.home?.price}`,
        `away: ${sp.away?.team}  point ${sp.away?.point}  price ${sp.away?.price}`,
        sp.implied ? `no-vig p(home): ${(sp.implied.pA*100).toFixed(2)}%  p(away): ${(sp.implied.pB*100).toFixed(2)}%  overround: ${(sp.implied.overround*100).toFixed(2)}%` : '',
      ].filter(Boolean).join('\n');

      set($('ah'), lines + '\n\n' + jfmt(sp));
    }

    async function listSnapshots(){
      const id=String($('fid').value||'').trim();
      if(!id) return alert('请输入 fid(matchId)');
      const u=new URL('/api/track/snapshots_spreads', location.origin);
      u.searchParams.set('matchId', id);
      const r=await fetch(u);
      const j=await r.json();
      if(!r.ok){ $('tb').innerHTML = `<tr><td colspan="7">error: ${r.status} ${jfmt(j)}</td></tr>`; return; }
      const rows=j.rows||[];
      $('tb').innerHTML = rows.map(x=>{
        const sp=x.spreads||null;
        const line=sp? (sp.home?.point ?? '') : '';
        const h=sp? (sp.home?.price ?? '') : '';
        const a=sp? (sp.away?.price ?? '') : '';
        const bm=(sp && (sp.bookmaker||sp.key)) ? (sp.bookmaker||sp.key) : (x.bookmaker_id||'');
        return `<tr><td>${x.created_at}</td><td>${x.source}</td><td>${x.league_key||''}</td><td>${bm||''}</td><td>${line}</td><td>${h}</td><td>${a}</td></tr>`;
      }).join('');
    }

    $('loadMeta').addEventListener('click', ()=>loadMeta().catch(e=>set($('meta'), String(e))));
    $('snap').addEventListener('click', ()=>snapshotAH().catch(e=>set($('ah'), String(e))));
    $('list').addEventListener('click', ()=>listSnapshots().catch(e=>$('tb').innerHTML=`<tr><td colspan="7">${String(e)}</td></tr>`));

    // init
    $('date').value = $('date').value || todayISO();

    // auto-load if fid present
    if(String($('fid').value||'').trim()) loadMeta().catch(()=>{});
  </script>
</AppLayout>
