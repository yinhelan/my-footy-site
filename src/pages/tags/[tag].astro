---
import { getCollection } from 'astro:content';
import SiteHeader from '../../components/SiteHeader.astro';

export async function getStaticPaths() {
  const posts = await getCollection('articles', ({ data }) => data.draft !== true);
  const tagSet = new Set<string>();
  for (const p of posts) for (const t of (p.data.tags ?? [])) tagSet.add(t);
  return Array.from(tagSet).map((t) => ({ params: { tag: encodeURIComponent(t) } }));
}

const tag = decodeURIComponent(Astro.params.tag!);
const posts = (await getCollection('articles', ({ data }) => data.draft !== true))
  .filter((p) => (p.data.tags ?? []).includes(tag))
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
---
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>{tag} · Tags</title>
  </head>
  <body class="min-h-screen bg-neutral-50 text-neutral-900">
    <SiteHeader />
    <main class="max-w-4xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-6">#{tag}</h1>
      {posts.length === 0 ? (
        <p class="text-neutral-500">暂无文章。</p>
      ) : (
        <ul class="space-y-4">
          {posts.map(({ slug, data }) => (
            <li class="p-4 bg-white rounded-2xl border shadow-sm">
              <a class="text-xl font-semibold hover:underline" href={`/articles/${slug}/`}>{data.title}</a>
              {data.description && <p class="text-sm text-neutral-600 mt-1">{data.description}</p>}
              <div class="text-xs text-neutral-500 mt-2">{new Date(data.date).toLocaleDateString('zh-CN')}</div>
            </li>
          ))}
        </ul>
      )}
    </main>
  </body>
</html>
